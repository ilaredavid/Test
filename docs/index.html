<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Rules taxonomy – interactive database</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 2rem;
    }
    table.dataTable {
      width: 100% !important;
    }
    .dataTables_wrapper {
      width: 100%;
      overflow-x: auto;
    }
    table.dataTable tbody td {
      white-space: normal;
      word-break: break-word;
    }
    table.dataTable.stripe tbody tr:nth-child(odd) {
      background-color: #f7f7f7;
    }
    table.dataTable thead th {
      position: sticky;
      top: 0;
      background: #ffffff;
      z-index: 1;
    }
  </style>
</head>
<body>
  <h1>Taxonomy V4</h1>
  <p>
    Search, sort and filter all the content included in the version 4.  
    You can download the raw CSV file from
    <a href="rules_taxonomy_v4.csv">here</a>.
  </p>

  <table id="rules-table" class="display" style="width:100%">
    <thead>
      <tr id="rules-header-row"></tr>
    </thead>
    <tbody id="rules-body">
      <!-- Filled by JavaScript -->
    </tbody>
  </table>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- DataTables -->
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <!-- Read CSV files -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const csvUrl = 'rules_taxonomy_v4.csv';
  
    fetch(csvUrl)
      .then(response => response.arrayBuffer())
      .then(buffer => {
        const decoder = new TextDecoder("utf-8");
        const csvText = decoder.decode(buffer);
        return csvText;
      })
      .then(csvText => {
        const parsed = Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true
        });
  
        const fields = parsed.meta.fields; // original field names
        const data = parsed.data;
  
        // --- DEBUG: muestra campos detectados en consola (puedes quitar después)
        console.log("Detected CSV fields:", fields);
  
        // Build header
        const headerRow = document.getElementById('rules-header-row');
        fields.forEach(name => {
          const th = document.createElement('th');
          th.textContent = name;
          headerRow.appendChild(th);
        });
  
        // --- Find index of "Type" robustly: normalize field names
        const normalizeField = f => (f ?? '').replace(/[\uFEFF\u00A0\u200B]/g, '').replace(/[\r\n]/g, '').trim().toUpperCase();
        const typeColumnIndex = fields.findIndex(f => normalizeField(f) === 'TYPE');
        console.log("typeColumnIndex:", typeColumnIndex); // -1 if not found
  
        // Fill table body
        const tbody = document.getElementById('rules-body');
  
        data.forEach(row => {
          const tr = document.createElement('tr');
  
          fields.forEach((name, colIdx) => {
            const td = document.createElement('td');
            let cellValue = row[name] ?? '';
  
            // Normalize cell value (robust)
            let normalized = (cellValue ?? '')
              .replace(/[\uFEFF\u00A0\u200B]/g, '')
              .replace(/[\r\n]/g, '')
              .trim()
              .toUpperCase();
  
            // DEBUG: si quieres ver valores para la fila problema, descomenta:
            // if (normalized.includes('AGGREGATION')) console.log('Row value normalized:', normalized, 'original:', JSON.stringify(cellValue));
  
            // Use normalized and also ensure that the column index was found
            if (typeColumnIndex !== -1 && colIdx === typeColumnIndex && normalized === "AGGREGATION") {
              // Show trimmed original value as link text
              const displayText = (cellValue ?? '').replace(/[\uFEFF\u00A0\u200B]/g, '').replace(/[\r\n]/g, '').trim();
              td.innerHTML = `<a href="https://github.com/ResilientRules/Rules-taxonomy/blob/main/FAQ/2%20Aggregation%20rules.md" target="_blank" rel="noopener noreferrer">${escapeHtml(displayText)}</a>`;
            } else {
              td.textContent = cellValue;
            }
  
            tr.appendChild(td);
          });
  
          tbody.appendChild(tr);
        });
  
        // ----------- CREATE FILTER ROW -----------
        const thead = headerRow.parentElement;
        const filterRow = document.createElement('tr');
        filterRow.classList.add("filters");
  
        fields.forEach((field) => {
          const th = document.createElement('th');
  
          const input = document.createElement("input");
          input.type = "text";
          input.placeholder = "Filter…";
          input.classList.add("filter-input");
  
          th.appendChild(input);
          filterRow.appendChild(th);
        });
  
        thead.appendChild(filterRow);
  
        // ------------- INIT DATATABLES -------------------
        const table = $('#rules-table').DataTable({
          pageLength: 25,
          lengthMenu: [10, 25, 50, 100],
          order: [],
          scrollX: true,
          autoWidth: true,
          language: {
            url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/en-US.json"
          }
        });
  
        // ----------- APPLY FILTERS PER COLUMN --------------
        table.columns().every(function (colIdx) {
          const input = thead.querySelectorAll("tr.filters input")[colIdx];
  
          input.addEventListener("keyup", function () {
            table.column(colIdx).search(this.value).draw();
          });
        });
  
        // small html-escape for link text
        function escapeHtml(s) {
          return String(s)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
        }
  
      })
      .catch(error => {
        console.error(error);
        alert('Error loading table. Check console.');
      });
  </script>
</body>
</html>

