<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Rules taxonomy – interactive database</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 2rem;
      background: #fafafa;
      color: #222;
      line-height: 1.55;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    p {
      max-width: 900px;
      font-size: 1rem;
      margin-bottom: 1rem;
      color: #333;
    }
    table.dataTable {
      width: 100% !important;
      border-collapse: collapse;
      border: 1px solid #dcdcdc;
      background: white;
      font-size: 15px;
    }
    .dataTables_wrapper {
      width: 100%;
      overflow-x: auto;
    }
    
    /* ---- HEADER -----*/
     table.dataTable thead th {
      background: #f3f3f3;
      color: #222;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      padding: 10px 12px;
      border-bottom: 2px solid #d0d0d0;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    /* ---- BODY -----*/
    table.dataTable tbody td {
      white-space: normal;
      word-break: break-word;
      padding: 10px 12px;
    border-bottom: 1px solid #ececec;
    }
    table.dataTable.stripe tbody tr:nth-child(odd) {
      background-color: #fafafa;
    }

    /* ----- LINKS inside table ----- */
    table.dataTable td a {
      text-decoration: none;
      color: #0056b3;
      font-weight: 600;
    }
    
    table.dataTable td a:hover {
      text-decoration: underline;
      color: #003f80;
    }
   /* ===========================
         DARK MODE THEME
   =========================== */

  body.dark {
    background: #1a1a1a;
    color: #e6e6e6;
  }
  
  /* Header & text */
  body.dark h1 {
    color: #ffffff;
  }
  
  body.dark p {
    color: #dcdcdc;
  }
  
  /* DataTable general */
  body.dark table.dataTable {
    background: #262626;
    color: #e6e6e6;
    border-color: #555;
  }
  
  /* Header cells */
  body.dark table.dataTable thead th {
    background: #333 !important;
    color: #e6e6e6;
    border-bottom: 2px solid #555;
  }
  
  /* Body cells */
  body.dark table.dataTable tbody td {
    border-color: #444;
    color: #e6e6e6;
  }
  
  /* Zebra stripes */
  body.dark table.dataTable.stripe tbody tr:nth-child(odd) {
    background-color: #2a2a2a !important;
  }
  
  /* Hover */
  body.dark table.dataTable tbody tr:hover {
    background-color: #3a3a3a !important;
  }
  
  /* Filter inputs */
  body.dark .filter-input {
    background: #2e2e2e;
    color: #e6e6e6;
    border: 1px solid #555;
  }
  
  body.dark .filter-input:focus {
    border-color: #66aaff;
    box-shadow: 0 0 3px rgba(102,170,255,0.35);
  }
  
  /* Links */
  body.dark table.dataTable td a {
    color: #7ab8ff;
  }
  
  body.dark table.dataTable td a:hover {
    color: #a8d2ff;
  }
  .dark-mode-btn {
    position: fixed;
    top: 15px;
    right: 20px;
    background: #f0f0f0;
    border: none;
    border-radius: 50%;
    padding: 10px;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    transition: background 0.3s ease, transform 0.2s ease;
  }

  .dark-mode-btn:hover {
      transform: scale(1.1);
  }

  .dark-mode-btn svg {
      color: #333;
  }

  /* Dark mode styles */
  body.dark-mode .dark-mode-btn {
      background: #333;
  }

  body.dark-mode .dark-mode-btn svg {
      color: #fff;
  }

  </style>
</head>
<body>
  <button id="darkModeToggle" class="dark-mode-btn" aria-label="Toggle dark mode">
    <svg id="darkModeIcon" width="20" height="20" viewBox="0 0 24 24">
        <path fill="currentColor" 
              d="M12 2a1 1 0 0 1 1 1v2a1 1 0 0 1-2 0V3a1 1 0 0 1 1-1zm7.07 3.93a1 1 0 0 1 
              0 1.41l-1.41 1.41a1 1 0 1 1-1.41-1.41l1.41-1.41a1 1 0 0 1 1.41 0zM21 
              11h-2a1 1 0 0 1 0-2h2a1 1 0 1 1 0 2zm-3.93 7.07a1 1 0 0 1-1.41 0l-1.41-1.41a1 1 
              0 0 1 1.41-1.41l1.41 1.41a1 1 0 0 1 0 1.41zM13 21v-2a1 1 0 1 1 2 0v2a1 1 
              0 1 1-2 0zm-7.07-3.93a1 1 0 0 1 0-1.41l1.41-1.41a1 1 
              0 1 1 1.41 1.41L7.34 17.07a1 1 0 0 1-1.41 0zM3 13H1a1 1 0 1 1 0-2h2a1 1 
              0 1 1 0 2zm3.93-7.07a1 1 0 0 1 1.41 0l1.41 1.41A1 1 
              0 1 1 8.34 8.76L6.93 7.34a1 1 0 0 1 0-1.41zM12 7a5 5 0 1 0 0 10 5 5 
              0 0 0 0-10z"/>
    </svg>
  </button>
  <h1>Taxonomy V4</h1>
  <p>
    Search, sort and filter all the content included in the version 4.  
    You can download the raw CSV file from <a href="rules_taxonomy_v4.csv">here</a>.
  </p>
  <p>
    For further information, please refer to the entries in each typology, which include a dedicated FAQ section.
  </p>

  <table id="rules-table" class="display" style="width:100%">
    <thead>
      <tr id="rules-header-row"></tr>
    </thead>
    <tbody id="rules-body">
      <!-- Filled by JavaScript -->
    </tbody>
  </table>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- DataTables -->
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <!-- Read CSV files -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const csvUrl = 'rules_taxonomy_v4.csv';
  
    fetch(csvUrl)
      .then(response => response.arrayBuffer())
      .then(buffer => {
        const decoder = new TextDecoder("utf-8");
        const csvText = decoder.decode(buffer);
        return csvText;
      })
      .then(csvText => {
        const parsed = Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true
        });
  
        const fields = parsed.meta.fields; // original field names
        const data = parsed.data;
        
        // Build header
        const headerRow = document.getElementById('rules-header-row');
        fields.forEach(name => {
          const th = document.createElement('th');
          th.textContent = name;
          headerRow.appendChild(th);
        });
  
        // --- Find index of "Type" robustly: normalize field names
        const normalizeField = f => (f ?? '').replace(/[\uFEFF\u00A0\u200B]/g, '').replace(/[\r\n]/g, '').trim().toUpperCase();
        const typeColumnIndex = fields.findIndex(f => normalizeField(f) === 'TYPE');
        console.log("typeColumnIndex:", typeColumnIndex); // -1 if not found
  
        // Fill table body
        const tbody = document.getElementById('rules-body');
        
        const typeLinks = {
              "AGGREGATION": "https://github.com/ResilientRules/Rules-taxonomy/blob/main/FAQ/2%20Aggregation%20rules.md",
              "BOUNDARY": "https://github.com/ResilientRules/Rules-taxonomy/blob/main/FAQ/3%20Boundary%20rules.md",
              "CHOICE": "https://github.com/ResilientRules/Rules-taxonomy/blob/main/FAQ/4%20Choice%20rules.md",
              "INFORMATION": "https://github.com/ResilientRules/Rules-taxonomy/blob/main/FAQ/5%20Information%20rules.md",
              "PAYOFF": "https://github.com/ResilientRules/Rules-taxonomy/blob/main/FAQ/6%20Payoff%20rules.md",
              "POSITION": "https://github.com/ResilientRules/Rules-taxonomy/blob/main/FAQ/7%20Position%20rules.md",
              "SCOPE": "https://github.com/ResilientRules/Rules-taxonomy/blob/main/FAQ/8%20Scope%20rules.md"
            };
  
        data.forEach(row => {
          const tr = document.createElement('tr');
          fields.forEach((name, colIdx) => {
            const td = document.createElement('td');
            let cellValue = row[name] ?? '';
        
            // Normalize cell value (robust)
            let normalized = (cellValue ?? '')
              .replace(/[\uFEFF\u00A0\u200B]/g, '')
              .replace(/[\r\n]/g, '')
              .trim()
              .toUpperCase();
        
            // If this is the Type column → insert link
            if (colIdx === typeColumnIndex) {
              const link = typeLinks[normalized];
              if (link) {
                const displayText = (cellValue ?? '')
                  .replace(/[\uFEFF\u00A0\u200B]/g, '')
                  .replace(/[\r\n]/g, '')
                  .trim();
        
                td.innerHTML = `
                  <a href="${link}" target="_blank" rel="noopener noreferrer">
                    ${escapeHtml(displayText)}
                  </a>`;
              } else {
                td.textContent = cellValue;
              }
            } else {
              td.textContent = cellValue;
            }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
  
        // ----------- CREATE FILTER ROW -----------
        const thead = headerRow.parentElement;
        const filterRow = document.createElement('tr');
        filterRow.classList.add("filters");
  
        fields.forEach((field) => {
          const th = document.createElement('th');
  
          const input = document.createElement("input");
          input.type = "text";
          input.placeholder = "Filter…";
          input.classList.add("filter-input");
  
          th.appendChild(input);
          filterRow.appendChild(th);
        });
  
        thead.appendChild(filterRow);
  
        // ------------- INIT DATATABLES -------------------
        const table = $('#rules-table').DataTable({
          pageLength: 25,
          lengthMenu: [10, 25, 50, 100],
          order: [],
          scrollX: true,
          autoWidth: true,
          language: {
            url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/en-US.json"
          }
        });
  
        // ----------- APPLY FILTERS PER COLUMN --------------
        table.columns().every(function (colIdx) {
          const input = thead.querySelectorAll("tr.filters input")[colIdx];
  
          input.addEventListener("keyup", function () {
            table.column(colIdx).search(this.value).draw();
          });
        });
  
        // small html-escape for link text
        function escapeHtml(s) {
          return String(s)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
        }
  
      })
      .catch(error => {
        console.error(error);
        alert('Error loading table. Check console.');
      });
    
    // ======================
    // DARK MODE TOGGLE
    // ======================
    const toggleBtn = document.getElementById("theme-toggle");
    
    document.getElementById("darkModeToggle").addEventListener("click", function () {
        document.body.classList.toggle("dark-mode");
    
      // Save preference
      if (document.body.classList.contains("dark-mode")) {
          localStorage.setItem("darkMode", "enabled");
      } else {
          localStorage.setItem("darkMode", "disabled");
      }
    });

    // Load saved preference
    if (localStorage.getItem("darkMode") === "enabled") {
        document.body.classList.add("dark-mode");
    }
  </script>
</body>
</html>

